name: Release Build (Signed APK)

on:
  push:
    tags:
      - 'v*'
    branches: [ main, master ]
    paths:
      - 'Android-kotlin-Code/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v3.2.3)'
        required: true
        default: 'v3.2.3'
        type: string

jobs:
  release-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Grant execute permission for gradlew
      run: chmod +x Android-kotlin-Code/gradlew

    - name: Decode Keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > Android-kotlin-Code/release.keystore
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

    - name: Create signing.properties
      run: |
        cat > Android-kotlin-Code/signing.properties << EOF
        keystore.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        key.alias=${{ secrets.ANDROID_KEY_ALIAS }}
        key.password=${{ secrets.ANDROID_KEY_PASSWORD }}
        EOF

    - name: Update Version for Android 14 Compatibility
      run: |
        cd Android-kotlin-Code
        # ç¡®ä¿ä½¿ç”¨Android 14å…¼å®¹é…ç½®
        sed -i 's/targetSdk = 33/targetSdk = 34/' build.gradle.kts
        sed -i 's/compileSdkVersion(33)/compileSdkVersion(34)/' build.gradle.kts

    - name: Build Signed APK
      run: |
        cd Android-kotlin-Code
        echo "Starting build process..."
        ./gradlew assembleAlphaRelease -x lint -x test --no-daemon --stacktrace --continue
        echo "Build process completed"
        echo "Checking build results..."
        ls -la app/build/outputs/apk/ || echo "APK directory not found"

    - name: Find APK Files
      run: |
        echo "Searching for APK files..."
        find Android-kotlin-Code -name "*.apk" -type f
        echo ""
        echo "APK files found:"
        ls -la Android-kotlin-Code/app/build/outputs/apk/alpha/release/ || echo "Release directory not found"
        ls -la Android-kotlin-Code/app/build/outputs/apk/alpha/debug/ || echo "Debug directory not found"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: Android-kotlin-Code/app/build/outputs/apk/**/*.apk
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: UUVPN ${{ github.event.inputs.version || github.ref_name }} (Official Release)
        body: |
          ## ðŸš€ UUVPN Android App - Official Release
          
          ### ðŸ“± åº”ç”¨ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.event.inputs.version || github.ref_name }}
          - **æž„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp || github.event.created_at }}
          - **æž„å»ºç±»åž‹**: Official Release (å·²ç­¾å)
          
          ### ðŸ”§ å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾ç½®ä¸­å¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. å®‰è£…APKæ–‡ä»¶
          
          ### ðŸŒ APIé…ç½®
          - **APIæœåŠ¡å™¨**: https://tianque.126581.xyz
          - **é…ç½®ç«¯ç‚¹**: https://tianque.126581.xyz/config
          - **VPNèŠ‚ç‚¹**: https://tianque.126581.xyz/api/vpnnodes.php
          
          ### ðŸ“‹ åŠŸèƒ½ç‰¹æ€§
          - âœ… ç”¨æˆ·ç™»å½•/æ³¨å†Œ
          - âœ… VPNè¿žæŽ¥ç®¡ç†
          - âœ… å¥—é¤è®¢é˜…
          - âœ… è®¢å•ç®¡ç†
          - âœ… å·¥å•æ”¯æŒ
          
          ### ðŸ” å®‰å…¨ä¿¡æ¯
          - **APKç­¾å**: å·²ä½¿ç”¨æ­£å¼ç­¾åå¯†é’¥
          - **å®‰å…¨ç­‰çº§**: ç”Ÿäº§çŽ¯å¢ƒå¯ç”¨
          
          ### ðŸ”— æž„å»ºä¿¡æ¯
          - **æäº¤**: ${{ github.sha }}
          - **æ ‡ç­¾**: ${{ github.ref_name }}
          - **è§¦å‘è€…**: ${{ github.actor }}
          
          ### ðŸ“ å‘å¸ƒè¯´æ˜Ž
          - æ­¤ç‰ˆæœ¬ä¸ºæ­£å¼ç­¾åç‰ˆæœ¬ï¼Œå¯ç›´æŽ¥ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒ
          - å»ºè®®åœ¨å‘å¸ƒå‰è¿›è¡Œå……åˆ†æµ‹è¯•
          - å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤Issueæˆ–è”ç³»å¼€å‘è€…
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show Build Info
      run: |
        echo "Official Release Build completed!"
        echo "APK files:"
        ls -la Android-kotlin-Code/app/build/outputs/apk/alpha/release/ || echo "Release directory not found, checking other locations..."
        ls -la Android-kotlin-Code/app/build/outputs/apk/alpha/debug/ || echo "Debug directory not found"
        echo ""
        echo "All APK files in project:"
        find Android-kotlin-Code -name "*.apk" -type f || echo "No APK files found"
        echo ""
        echo "Build output structure:"
        ls -la Android-kotlin-Code/app/build/outputs/ || echo "Outputs directory not found"
        echo ""
        echo "Release created at:"
        echo "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
