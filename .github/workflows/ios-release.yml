name: iOS Release (With Apple Developer Account)

on:
  release:
    types: [published]

jobs:
  ios-release:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Install Apple Certificate
      uses: apple-actions/import-codesigning-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
        p12-password: ${{ secrets.IOS_P12_PASSWORD }}

    - name: Install Provisioning Profile
      uses: apple-actions/download-provisioning-profiles@v1
      with:
        bundle-id: ${{ secrets.IOS_BUNDLE_ID }}
        profile-type: IOS_APP_STORE
        issuer-id: ${{ secrets.IOS_ISSUER_ID }}
        api-key-id: ${{ secrets.IOS_API_KEY_ID }}
        api-private-key: ${{ secrets.IOS_API_PRIVATE_KEY }}

    - name: Build iOS App
      run: |
        cd iOS-SwiftUI-Code
        xcodebuild -project uuvpn.xcodeproj \
          -scheme uuvpn \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath build/uuvpn.xcarchive \
          archive

    - name: Export IPA
      run: |
        cd iOS-SwiftUI-Code
        xcodebuild -exportArchive \
          -archivePath build/uuvpn.xcarchive \
          -exportPath build/export \
          -exportOptionsPlist exportOptions.plist

    - name: Upload IPA to Release
      uses: softprops/action-gh-release@v2
      with:
        files: iOS-SwiftUI-Code/build/export/*.ipa
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
